<!DOCTYPE html>
<html><head><title>IPerturbed Implementation for Functions</title><meta charset="UTF-8"><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="The following section, along with [[emmy.collection]] and [[emmy.differential]], rounds out the implementations of [[d/IPerturbed]] for native Clojure(script) data types. The function implementation is subtle, as described by Manzyuk et al. 2019. ([[emmy.derivative.calculus-test]], in the &quot;Amazing Bug&quot; sections, describes the pitfalls at length.)" property="og:description"><meta content="IPerturbed Implementation for Functions" property="og:title"><meta content="article:clerk" property="og:type"><meta content="summary_large_image" name="twitter:card"><script src="https://cdn.tailwindcss.com?plugins=typography" type="text/javascript"></script><script>tailwind.config = {
  darkMode: "class",
  content: ["./tw/viewer.js", "./tw/**/*.edn"],
  safelist: ['dark'],
  theme: {
    extend: {},
    fontFamily: {
      sans: ["Fira Sans", "-apple-system", "BlinkMacSystemFont", "sans-serif"],
      serif: ["PT Serif", "serif"],
      mono: ["Fira Mono", "monospace"]
    }
  },
  variants: {
    extend: {},
  },
  plugins: [],
}
</script><style type="text/tailwindcss">@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    font-size: 18px;
  }
  @media (max-width: 600px) {
    html {
      font-size: 16px;
    }
  }
  .font-condensed { font-family: "Fira Sans Condensed", sans-serif; }
  .font-inter     { font-family: "Inter", sans-serif; }
  body {
    @apply font-serif antialiased text-gray-900 sm:overscroll-y-none;
  }
  code, .code {
    @apply font-mono text-sm text-gray-900 bg-slate-50 px-0.5 py-px rounded dark:bg-gray-800;
  }
  code::before, code::after { @apply content-none !important; }
  h1, h3, h4, h5, h6 {
    @apply font-condensed font-bold mt-8 first:mt-0;
  }
  h2 {
    /*We cannot collapse margins due to nesting but we want to*/
    /*keep the h2’s large margin visible*/
    @apply font-condensed font-bold mt-8 first:mt-2;
  }
  h1 { @apply text-4xl; }
  h2 { @apply text-3xl; }
  h3 { @apply text-2xl; }

  @media print {
      h1 { @apply text-2xl !important; }
      h2 { @apply text-xl !important; }
      h3 { @apply text-lg !important; }
  }

  button { @apply focus:outline-none; }
  strong { @apply font-bold; }
  em     { @apply italic; }
  pre    { @apply m-0 font-mono; }
}

/* Compatibility */
/* --------------------------------------------------------------- */
/* TODO: Verify which colors are in use and replace with Tailwind
   colors accordingly. Move Nj-specific styles out of here. */

:root {
  --teal-color: #31afd0;
  --dark-teal-color: #095960;
  --near-black-color: #2e2e2c;
  --red-color: #d64242;
  --dark-blue-color: #1f2937;
  --dark-blue-60-color: rgba(28, 42, 56, 0.6);
  --gray-panel-color: rgba(239, 241, 245, 1.000);
  --brand-color: var(--dark-blue-color);
  --link-color: #5046e4;
  --command-bar-selected-color: var(--teal-color);
}

.serif      { @apply font-serif; }
.sans-serif { @apply font-sans; }
.monospace  { @apply font-mono; }
.inter      { @apply font-inter; }

.border-color-teal { border-color: var(--dark-teal-color); }
.teal { color: var(--teal-color); }
.bg-dark-blue { background: var(--dark-blue-color); }
.bg-dark-blue-60 { background: rgba(28, 42, 56, 0.6); }
.bg-gray-panel { background: var(--gray-panel-color); }
.text-dark-blue  { color: var(--dark-blue-color); }
.text-dark-blue-60 { color: var(--dark-blue-60-color); }
.border-dark-blue-30 { border-color: rgba(28, 42, 56, 0.6); }
.text-brand { color: var(--dark-blue-color); }
.bg-brand { background: var(--dark-blue-color); }
.text-selected { color: white; }
.red { color: var(--red-color); }

/* Disclose Button */
/* --------------------------------------------------------------- */

.disclose {
  @apply content-none border-solid cursor-pointer inline-block relative mr-[3px] top-[-2px] transition-all;
  border-color: var(--near-black-color) transparent;
  border-width: 6px 4px 0;
}
.disclose:hover {
  border-color: var(--near-black-color) transparent;
}
.dark .disclose,
.dark .disclose:hover {
  border-color: white transparent;
}
.disclose.collapsed {
  @apply rotate-[-90deg];
}

/* Layout */
/* --------------------------------------------------------------- */

.page {
  @apply max-w-5xl mx-auto px-12 box-border flex-shrink-0;
}
.max-w-prose { @apply max-w-[46rem] !important; }
.max-w-wide  { @apply max-w-3xl !important; }

/* List Styles */
/* --------------------------------------------------------------- */

.task-list-item + .task-list-item,
.markdown-viewer ul ul {
  @apply mt-1 mb-0;
}

/* compact TOC */
.markdown-viewer .toc ul {
  list-style: none;
  @apply my-1;
}

/* Code Viewer */
/* --------------------------------------------------------------- */

.code-viewer {
  @apply font-mono bg-slate-100 rounded-sm text-sm overflow-x-auto dark:bg-gray-800;
}
.code-listing  {
    @apply -ml-8 -mr-8 relative !important;
}
.code-viewer .cm-content {
  @apply py-4 px-8;
}
@media (min-width: 960px){
    .notebook-viewer .code-viewer .cm-content {
        @apply py-4 pl-12;
    }
    .notebook-viewer .code-listing {
        width: 48rem !important;
        @apply -ml-12 mr-0 !important;
    }
}
/* Don’t show focus outline when double-clicking cell in Safari */
.cm-scroller { @apply focus:outline-none; }

/* Syntax Highlighting */
/* --------------------------------------------------------------- */

.inspected-value { @apply text-xs font-mono leading-[1.25rem]; }
.cmt-strong, .cmt-heading { @apply font-bold; }
.cmt-italic, .cmt-emphasis { @apply italic; }
.cmt-strikethrough { @apply line-through; }
.cmt-link { @apply underline; }
.untyped-value { @apply whitespace-nowrap; }

.cm-editor, .cmt-default, .result-viewer {
  @apply text-slate-800 dark:text-slate-300;
}
.cmt-keyword {
  @apply text-purple-800 dark:text-pink-400;
}
.cmt-atom, .cmt-bool, .cmt-url, .cmt-contentSeparator, .cmt-labelName {
  @apply text-blue-900 dark:text-blue-300;
}
.cmt-inserted, .cmt-literal {
  @apply text-emerald-700 dark:text-emerald-200;
}
.cmt-string, .cmt-deleted {
  @apply text-rose-700 dark:text-sky-300;
}
.cmt-italic.cmt-string {
  @apply dark:text-sky-200;
}
.cmt-regexp, .cmt-escape {
  @apply text-orange-500 dark:text-orange-300;
}
.cmt-variableName {
  @apply text-blue-800 dark:text-sky-300;
}
.cmt-typeName, .cmt-namespace {
  @apply text-emerald-600 dark:text-emerald-300;
}
.cmt-className {
  @apply text-teal-600 dark:text-teal-200;
}
.cmt-macroName {
  @apply text-teal-700 dark:text-teal-200;
}
.cmt-propertyName {
  @apply text-blue-700 dark:text-blue-200;
}
.cmt-comment {
  @apply text-slate-500 dark:text-slate-400;
}
.cmt-meta {
  @apply text-slate-600 dark:text-slate-400;
}
.cmt-invalid {
  @apply text-red-500 dark:text-red-300;
}

.result-data {
  @apply font-mono text-sm overflow-x-auto whitespace-nowrap leading-normal;
}
.result-data::-webkit-scrollbar, .path-nav::-webkit-scrollbar {
  @apply h-0;
}
.result-data-collapsed {
  @apply whitespace-nowrap;
}
.result-data-field {
  @apply ml-4 whitespace-nowrap;
}
.result-data-field-link{
  @apply ml-4 whitespace-nowrap cursor-pointer;
}
.result-data-field-link:hover {
  @apply text-black bg-black/5;
}
.result-text-empty {
  color: rgba(0,0,0,.3);
}
.browsify-button:hover {
  box-shadow: -2px 0 0 2px #edf2f7;
}

/* Prose */
/* --------------------------------------------------------------- */

.notebook-viewer,
.markdown-viewer {
  @apply prose
    dark:prose-invert
    prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline
    dark:prose-a:text-blue-300
    prose-p:mt-4 prose-p:leading-snug
    prose-ol:mt-4 prose-ol:mb-6 prose-ol:leading-snug
    prose-ul:mt-4 prose-ul:mb-6 prose-ul:leading-snug
    prose-blockquote:mt-4 prose-blockquote:leading-snug
    prose-hr:mt-6 prose-hr:border-t-2 prose-hr:border-solid prose-hr:border-slate-200
    prose-figure:mt-4
    prose-figcaption:mt-2 prose-figcaption:text-xs
    prose-headings:mb-4
    prose-table:mt-0
    prose-th:mb-0
    prose-img:my-0
    prose-code:font-medium prose-code:bg-slate-100
    max-w-none;
}
.markdown-viewer blockquote p:first-of-type:before,
.markdown-viewer blockquote p:last-of-type:after {
  @apply content-none;
}
.markdown-node-viewer.result-viewer.fragment-item {
    @apply mb-0 !important;
}

/* Images */
/* --------------------------------------------------------------- */


/* Todo Lists */
/* --------------------------------------------------------------- */

.contains-task-list {
  @apply pl-6 list-none;
}
.contains-task-list input[type="checkbox"] {
  @apply appearance-none h-4 w-4 rounded border border-slate-200 relative mr-[0.3rem] ml-[-1.5rem] top-[0.15rem];
}
.contains-task-list input[type="checkbox"]:checked {
  @apply border-indigo-600 bg-indigo-600 bg-no-repeat bg-contain;
  background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
}

/* Markdown TOC */
/* --------------------------------------------------------------- */

.markdown-viewer .toc      { @apply mt-4; }
.markdown-viewer h1 + .toc { @apply mt-8; }

.markdown-viewer .toc h1,
.markdown-viewer .toc h2,
.markdown-viewer .toc h3,
.markdown-viewer .toc h4,
.markdown-viewer .toc h5,
.markdown-viewer .toc h6 {
  @apply text-base text-indigo-600 font-sans my-0;
}
.markdown-viewer .toc a {
  @apply text-indigo-600 font-normal no-underline hover:underline;
}
.markdown-viewer .toc li    { @apply m-0; }
.markdown-viewer .toc ul ul { @apply pl-4; }

/* Notebook Spacing */
/* --------------------------------------------------------------- */

.notebook-viewer { @apply py-16; }
#clerk-static-app .notebook-viewer { @apply pt-[0.8rem] pb-16; }
.markdown-viewer *:first-child:not(.code-viewer):not(li):not(h2):not(.sidenote) { @apply mt-0; }
/*.viewer + .viewer { @apply mt-6; }*/
.viewer + .result-viewer { @apply mt-0; }
.code-viewer + .result-viewer { @apply mt-3; }
.markdown-viewer + .markdown-viewer { @apply mt-0; }

/* Sidenotes */
/* --------------------------------------------------------------- */

.sidenote-ref {
  @apply top-[-0.5em] w-auto h-auto inline border-0 bg-transparent m-0 pointer-events-none;
}
.sidenote {
  @apply block font-sans text-xs mt-4 bg-slate-100 dark:bg-slate-800 p-4;
  font-style: normal;
  font-weight: normal;
}
.sidenote-container {
  @apply mb-4;
}
@media (min-width: 860px) {
  .sidenote sup { @apply inline; }
  .sidenote-column {
    @apply w-[165px] absolute right-0 top-0 -mr-[205px];
  }
  .sidenote {
    @apply bg-transparent dark:bg-transparent p-0;
  }
  .sidenote:first-child {
    @apply mt-1;
  }
  .sidenotes-layout .markdown-viewer {
    @apply pr-[241px];
  }
  .sidenote-container {
    @apply relative mb-0;
  }
  .sidenotes-layout h1 {
    @apply w-[756px] !important;
  }
}
.code-viewer + .viewer:not(.code-viewer):not(.code-viewer-folded),
.code-viewer-folded + .viewer:not(.code-viewer):not(.code-viewer-folded),
.result-viewer:not(.markdown-node-viewer) + .result-viewer {
  @apply mt-2;
}
.code-viewer + .code-viewer-folded {
  @apply mt-4;
}
.result-viewer {
  @apply leading-tight mb-6;
}
.code-viewer.fragment-item.result-viewer {
  @apply mb-0 !important;
}
.result-viewer figure {
  @apply mt-0 !important;
}
@media (min-width: 768px) {
  .devcard-desc > div {
    @apply max-w-full m-0;
  }
}

/* Command Palette */
/* --------------------------------------------------------------- */

.nj-commands-input {
  @apply bg-transparent text-white;
}
.nj-context-menu-item:hover:not([disabled]) {
  @apply cursor-pointer;
  background-color: rgba(255,255,255,.14);
}

/* Devdocs */
/* --------------------------------------------------------------- */

.logo, .logo-white {
  @apply block indent-[-999em];
  background: url(/images/nextjournal-logo.svg) center center no-repeat;
}
.devdocs-body {
  @apply font-inter;
}

/* Workarounds */
/* --------------------------------------------------------------- */

/* Fixes vega viewer resizing into infinity */
.vega-embed .chart-wrapper { @apply h-auto !important; }
/* fixes fraction separators being overridden by tw’s border-color */
.katex * { @apply border-black; }

@media print {
    .dark-mode-toggle,
    .toc-toggle { @apply hidden; }
    .notebook-viewer { @apply pt-0; font-size: 12pt !important; margin-left: 0 !important; }
    .code-viewer .cm-content,
    .viewer-code .cm-content { @apply whitespace-pre-wrap !important; overflow: none; }
    .code-viewer .cm-line { font-size: 12pt !important; }
    html * { page-break-inside: avoid !important; }
    .toc-panel { @apply hidden; }
}
</style><script src="https://storage.clerk.garden/nextjournal/clerk-assets@MsfrCWFPFxPwKtMLymKe2NxPBwY/viewer.js?immutable=true" type="module"></script><link href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://fonts.bunny.net" rel="preconnect"><link href="https://fonts.bunny.net/css?family=fira-mono:400,700%7Cfira-sans:400,400i,500,500i,700,700i%7Cfira-sans-condensed:700,700i%7Cpt-serif:400,400i,700,700i" rel="stylesheet" type="text/css"></head><body><div id="clerk-static-app"></div><script type="module">let state = "{:out-path \"public/build\", :path->doc {\"src/emmy/calculus/derivative.cljc\" {:path [], :nextjournal/value {:toc {:type :toc, :children [{:children [{:type :toc, :content [{:type :text, :text \"IPerturbed Implementation for Functions\"}], :heading-level 2, :attrs {:id \"iperturbed-implementation-for-functions\"}, :path [:content 0], :children [{:type :toc, :content [{:type :text, :text \"Tag Replacement\"}], :heading-level 3, :attrs {:id \"tag-replacement\"}, :path [:content 21]}]} {:type :toc, :content [{:type :text, :text \"Protocol Implementation\"}], :heading-level 2, :attrs {:id \"protocol-implementation\"}, :path [:content 29]} {:type :toc, :content [{:type :text, :text \"Single and Multivariable Calculus\"}], :heading-level 2, :attrs {:id \"single-and-multivariable-calculus\"}, :path [:content 31]} {:type :toc, :content [{:type :text, :text \"Generic [[g/partial-derivative]] Installation\"}], :heading-level 2, :attrs {:id \"generic-[[g/partial-derivative]]-installation\"}, :path [:content 39]} {:type :toc, :content [{:type :text, :text \"Operators\"}], :heading-level 2, :attrs {:id \"operators\"}, :path [:content 45]} {:type :toc, :content [{:type :text, :text \"Derivative Utilities\"}], :heading-level 2, :attrs {:id \"derivative-utilities\"}, :path [:content 47]}], :type :toc}]}, :sidenotes? false, :toc-visibility true, :atom-var-name->state #viewer-eval (nextjournal.clerk.render/intern-atoms! {}), :ns #viewer-eval (ns emmy.calculus.derivative), :auto-expand-results? nil, :scope emmy.calculus.derivative, :bundle? false, :open-graph {:type \"article:clerk\", :title \"IPerturbed Implementation for Functions\", :description \"The following section, along with [[emmy.collection]] and [[emmy.differential]], rounds out the implementations of [[d/IPerturbed]] for native Clojure(script) data types. The function implementation is subtle, as described by Manzyuk et al. 2019. ([[emmy.derivative.calculus-test]], in the \\\"Amazing Bug\\\" sections, describes the pitfalls at length.)\"}, :title \"IPerturbed Implementation for Functions\", :blocks [{:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5drGsoUHfMMzwv6JmAZDbvDeaH68M1\"} [\"h2\" {:id \"iperturbed-implementation-for-functions\"} [:<> \"IPerturbed Implementation for Functions\"]] [:p [:<> \"The following section, along with [[emmy.collection]]\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"and [[emmy.differential]], rounds out the implementations\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"of [[d/IPerturbed]] for native Clojure(script) data types. The function\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"implementation is subtle, as described by \"] [:a {:href \"https://arxiv.org/pdf/1211.4892.pdf\"} [:<> \"Manzyuk et al.\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"2019\"]] [:<> \".\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"([[emmy.derivative.calculus-test]], in the \\\"Amazing Bug\\\" sections,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"describes the pitfalls at length.)\"]] [:p [:<> \"[[emmy.differential]] describes how each in-progress perturbed variable\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"in a derivative is assigned a \\\"tag\\\" that accumulates the variable's partial\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"derivative.\"]] [:p [:<> \"How do we interpret the case where \"] [:code [:<> \"((D f) x)\"]] [:<> \" produces a \"] [:em [:<> \"function\"]] [:<> \"?\"]] [:p [:a {:href \"https://arxiv.org/pdf/1211.4892.pdf\"} [:<> \"Manzyuk et al. 2019\"]] [:<> \" extends \"] [:code [:<> \"D\"]] [:<> \" to\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"functions \"] [:code [:<> \"f\"]] [:<> \" of type \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\mathbb{R}^n \\\\rightarrow \\\\alpha\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dspkZgXrsvrVyyn8N8QfXTGXbEniK\"}}] [:<> \", where\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\alpha::=\\\\mathbb{R}^m \\\\mid \\\\alpha_{1} \\\\rightarrow \\\\alpha_{2}\", :nextjournal/viewer {:name :nextjournal.markdown/block-formula, :render-fn #viewer-fn nextjournal.clerk.render/render-katex, :hash \"5dtLYB93Mi3NowoYurf1Ue76yrXtDC\"}}] [:p [:<> \"By viewing\"]] [:ul [:li [:<> [:code [:<> \"f\"]] [:<> \" as a (maybe curried) multivariable function that \"] [:em [:<> \"eventually\"]] [:<> \" must\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"produce an \"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value \"\\\\mathbb{R}^m\", :nextjournal/viewer {:name :nextjournal.markdown/formula, :render-fn #viewer-fn (fn [tex] (nextjournal.clerk.render/render-katex tex {:inline? true})), :hash \"5dspkZgXrsvrVyyn8N8QfXTGXbEniK\"}}]]] [:li [:<> [:<> \"The derivative \"] [:code [:<> \"(D f)\"]] [:<> \" as the partial derivative with respect to the first\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"argument of \"] [:code [:<> \"f\"]]]]] [:p [:<> \"A 3-level nest of functions will respond to \"] [:code [:<> \"D\"]] [:<> \" just like the flattened,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"non-higher-order version would respond to \"] [:code [:<> \"(partial 0)\"]] [:<> \". In other words,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"these two forms should evaluate to equivalent results:\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5drGsoUHfMMzwv6JmAZDbvDeaH68M1\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(comment\\n  (let [f (fn [x]\\n            (fn [y]\\n              (fn [z]\\n                (g/* x y z))))]\\n    ((((D f) 'x) 'y) 'z))\\n  ;;=> (* y z)\\n\\n  (((partial 0) g/*) 'x 'y 'z))\", :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5dteC2jDGJggFNXMrv4WZX1xotrwBU-code\", :loc {:line 55, :end-line 64, :column 1, :end-column 32}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5dtB8erZUzmo5xYNefsgVZAMw8pcsr\"} [:p [:<> \"=> (* y z)\"]] [:p [:<> \"To \"] [:code [:<> \"extract-tangent\"]] [:<> \" from a function, we need to compose the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:code [:<> \"extract-tangent\"]] [:<> \" operation with the returned function.\"]] [:p [:<> \"The returned function needs to capture an internal reference to the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"original [[d/Differential]] input. This is true for any Functor-shaped return\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"value, like a structure or Map. However! There is a subtlety present with\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"functions that's not present with vectors or other containers.\"]] [:p [:<> \"The difference with functions is that they take \"] [:em [:<> \"inputs\"]] [:<> \". If you contrive a\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"situation where you can feed the original captured [[d/Differential]] into\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"the returned function, this can trigger \\\"perturbation confusion\\\", where two\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"different layers try to extract the tangent corresponding to the SAME tag,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"and one is left with nothing.\"]] [:p [:<> \"If you engineer an\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"example (see [[emmy.calculus.derivative-test/amazing-bug]]) where:\"]] [:ul [:li [:<> [:<> \"this function takes another function, which then receives the closed-over\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:code [:<> \"x\"]] [:<> \" as an argument\"]]] [:li [:<> [:<> \"you pass this function to itself, so the closed-over \"] [:code [:<> \"x\"]] [:<> \" instances can both\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"be multiplied\"]]]] [:p [:<> \"Then your program isn't going to make any distinction between the instances\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"of \"] [:code [:<> \"x\"]] [:<> \". They're both references to the same value.\"]] [:p [:<> \"HOWEVER! \"] [:code [:<> \"((D f) x)\"]] [:<> \" returns a function which, when you eventually provide\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"all arguments, will return the sensitivity of \"] [:code [:<> \"f\"]] [:<> \" to the first argument \"] [:code [:<> \"x\"]] [:<> \".\"]] [:p [:<> \"If you perform the trick above, pass \"] [:code [:<> \"((D f) x)\"]] [:<> \" into itself, and the \"] [:code [:<> \"x\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"instances meet (multiply, say) - should final return value treat them as the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"/same/ instance?\"]] [:p [:<> \"Manzyuk et al. says \"] [:em [:<> \"NO!\"]] [:<> \". If \"] [:code [:<> \"((D f) x)\"]] [:<> \" returns a function, that function\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"closes over:\"]] [:ul [:li [:<> [:<> \"the value of \"] [:code [:<> \"x\"]]]] [:li [:<> [:<> \"an \"] [:em [:<> \"intention\"]] [:<> \" to start the derivative-taking process on that isolated copy\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"of \"] [:code [:<> \"x\"]] [:<> \" once the final argument is supplied.\"]]]] [:p [:<> \"How does the implementation keep the values separate?\"]] [\"h3\" {:id \"tag-replacement\"} [:<> \"Tag Replacement\"]] [:p [:<> \"The key to the solution lives in [[extract-tangent-fn]], called on the result\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"of \"] [:code [:<> \"((D f) x)\"]] [:<> \" when \"] [:code [:<> \"((D f) x)\"]] [:<> \" produces a function. We have to armor the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"returned function so that:\"]] [:ul [:li [:<> [:<> \"it extracts the originally-injected tag when someone eventually calls the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"function\"]]] [:li [:<> [:<> \"if some caller passes a new [[d/Differential]] instance into the function,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"any tags in that [[d/Differential]] will survive on their way back out...\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"even if they happen to contain the originally-injected tag.\"]]]] [:p [:<> \"We do this by:\"]] [:ul [:li [:<> [:<> \"replacing any instance of the original \"] [:code [:<> \"tag\"]] [:<> \" in the returned function's\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"arguments with a temporary tag (let's call it \"] [:code [:<> \"fresh\"]] [:<> \")\"]]] [:li [:<> [:<> \"calling the function and extracting the tangent component associated with\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:code [:<> \"tag\"]] [:<> \", as requested (note now that the only instances of \"] [:code [:<> \"tag\"]] [:<> \" that can\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"appear in the result come from variables captured in the function's\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"closure)\"]]] [:li [:<> [:<> \"remapping \"] [:code [:<> \"fresh\"]] [:<> \" back to \"] [:code [:<> \"tag\"]] [:<> \" inside the remaining [[d/Differential]]\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"instance.\"]]]] [:p [:<> \"This last step ensures that any tangent tagged with \"] [:code [:<> \"tag\"]] [:<> \" in the input can\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"make it back out without tangling with closure-captured \"] [:code [:<> \"tag\"]] [:<> \" instances that\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"some higher level might want.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5dtB8erZUzmo5xYNefsgVZAMw8pcsr\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(defn- extract-tangent-fn\\n  \\\"Returns a new function that composes a 'tag extraction' step with `f`. The\\n  returned fn will\\n\\n  - call the underlying `f`, producing `result`\\n  - return `(extract-tangent result tag)`\\n\\n  If called within the scope of a function waiting for the same `tag`, the\\n  returned function will remap any instance of `tag` that appears in any\\n  differential argument passed to it to a private `fresh` tag, to prevent\\n  internal perturbation confusion. Any tangent components in the final result\\n  tagged with `fresh` will be remapped in the final result back to `tag`.\\n\\n  If called _outside_ of a function waiting for `tag` no tag remapping will\\n  occur.\\\"\\n  [f tag]\\n  (-> (fn [& args]\\n        (if (d/tag-active? tag)\\n          (let [fresh (d/fresh-tag)]\\n            (-> (d/with-active-tag tag f (map #(d/replace-tag % tag fresh) args))\\n                (d/extract-tangent tag)\\n                (d/replace-tag fresh tag)))\\n          (-> (d/with-active-tag tag f args)\\n              (d/extract-tangent tag))))\\n      (f/with-arity (f/arity f))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/extract-tangent-fn-code\", :loc {:line 136, :end-line 160, :column 1, :end-column 35}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$extract_tangent_fn 0x11718d92 \\\"emmy.calculus.derivative$extract_tangent_fn@11718d92\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/extract-tangent-fn-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/extract-tangent-fn-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5drF6TSK7NcCZzXgd358CrKBw3Z61G\"} [:p [:<> \"NOTE: that the tag-remapping that the docstring for \"] [:code [:<> \"extract-tag-fn\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"describes might \"] [:em [:<> \"also\"]] [:<> \" have to apply to a functional argument!\"]] [:p [:code [:<> \"replace-tag\"]] [:<> \" on a function is meant to be a \"] [:code [:<> \"replace-tag\"]] [:<> \" call applied to\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"the function's \"] [:em [:<> \"output\"]] [:<> \". To prevent perturbation confusion inside the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"function, we perform a similar remapping of any occurrence of \"] [:code [:<> \"tag\"]] [:<> \" in the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"function's arguments.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5drF6TSK7NcCZzXgd358CrKBw3Z61G\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(defn- replace-tag-fn\\n  \\\"Returns a new function that composes a 'tag replacement' step with `f`.\\n\\n  If called within the scope of a function waiting for the same `tag`, the\\n  returned function will:\\n\\n  - make a fresh tag, and replace all `old` tags with `fresh` in the inputs\\n  - call `f`, producing `result`\\n  - return `(replace-tag result old new)`\\n  - remap any tangent component in the result tagged with `fresh` back to `old`.\\n\\n  If called _outside_ of a function waiting for `tag`, the returned function\\n  will apply `f` to its arguments and call `(replace-tag result old new)` with\\n  no tag-rerouting.\\\"\\n  [f old new]\\n  (-> (fn [& args]\\n        (if (d/tag-active? old)\\n          (let [fresh (d/fresh-tag)\\n                args  (map #(d/replace-tag % old fresh) args)]\\n            (-> (apply f args)\\n                (d/replace-tag old new)\\n                (d/replace-tag fresh old)))\\n          (-> (apply f args)\\n              (d/replace-tag old new))))\\n      (f/with-arity (f/arity f))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/replace-tag-fn-code\", :loc {:line 170, :end-line 194, :column 1, :end-column 35}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$replace_tag_fn 0x4535e7c9 \\\"emmy.calculus.derivative$replace_tag_fn@4535e7c9\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/replace-tag-fn-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/replace-tag-fn-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5du7vvHBCC7uQFHe9jCYsQBEfHnQuj\"} [\"h2\" {:id \"protocol-implementation\"} [:<> \"Protocol Implementation\"]] [:p [:<> \"The implementation for functions handles functions, multimethods, and, in\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"ClojureScript, [[MetaFn]] instances. Metadata in the original function is\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"preserved through tag replacement and extraction.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5du7vvHBCC7uQFHe9jCYsQBEfHnQuj\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(extend-protocol d/IPerturbed\\n\\n  MultiFn\\n  (perturbed? [_] false)\\n  (replace-tag [f old new] (replace-tag-fn f old new))\\n  (extract-tangent [f tag] (extract-tangent-fn f tag))\\n\\n  #?@(:clj\\n      [;; In Clojure, metadata can live directly on function objects.\\n       Fn\\n       (perturbed? [f] (:perturbed? (meta f) false))\\n       (replace-tag [f old new] (replace-tag-fn f old new))\\n       (extract-tangent [f tag] (extract-tangent-fn f tag))]\\n\\n      :cljs\\n      [;; In Clojurescript, we arrange for metadata to live directly on\\n       ;; function objects by setting a special property and implementing\\n       ;; IMeta: see [[emmy.value]].\\n       function\\n       (perturbed? [f] (:perturbed? (meta f) false))\\n       (replace-tag [f old new] (replace-tag-fn f old new))\\n       (extract-tangent [f tag] (extract-tangent-fn f tag))\\n       ;; The official way to get metadata onto a function in Clojurescript\\n       ;; is to promote the fn to an AFn-implementing object and store the\\n       ;; metadata on a directly-visible object property, which we also\\n       ;; support, although such objects are not naively callable in JavaScript\\n       MetaFn\\n       (perturbed? [f] (:perturbed? (.-meta f) false))\\n       (replace-tag [f old new]\\n                    (replace-tag-fn (.-afn f) old new))\\n       (extract-tangent [f tag]\\n                        (extract-tangent-fn (.-afn f) tag))]))\", :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5ds6rWyDkCgYJxtKHELCa9cFVc9cEJ-code\", :loc {:line 202, :end-line 233, :column 1, :end-column 63}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value nil, :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5ds6rWyDkCgYJxtKHELCa9cFVc9cEJ-result\"}, :nextjournal/viewer {:render-fn #viewer-fn (fn [_] [:span.cmt-default.inspected-value \"nil\"]), :hash \"5dtUvzjkkSGDKH896hrVHyYFWTpQG6\"}}, :nextjournal/blob-id \"5dsyVfvzXtFqjPBudFTVBocKyxzzEx\"}, :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5ds6rWyDkCgYJxtKHELCa9cFVc9cEJ-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5dr9depTfmBGP8zJo9TofSgMG3YzoJ\"} [\"h2\" {:id \"single-and-multivariable-calculus\"} [:<> \"Single and Multivariable Calculus\"]] [:p [:<> \"These functions put together the pieces laid out\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"in [[emmy.differential]] and declare an interface for taking\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"derivatives.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5dr9depTfmBGP8zJo9TofSgMG3YzoJ\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(defn derivative\\n  \\\"Returns a single-argument function of that, when called with an argument `x`,\\n  returns the derivative of `f` at `x` using forward-mode automatic\\n  differentiation.\\n\\n  For numerical differentiation,\\n  see [[emmy.numerical.derivative/D-numeric]].\\n\\n  `f` must be built out of generic operations that know how to\\n  handle [[d/Differential]] inputs in addition to any types that a normal `(f\\n  x)` call would present. This restriction does _not_ apply to operations like\\n  putting `x` into a container or destructuring; just primitive function calls.\\\"\\n  [f]\\n  (fn [x]\\n    (let [tag    (d/fresh-tag)\\n          lifted (d/bundle-element x 1 tag)]\\n      (-> (d/with-active-tag tag f [lifted])\\n          (d/extract-tangent tag)))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/derivative-code\", :loc {:line 241, :end-line 258, :column 1, :end-column 38}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$derivative 0x443fe678 \\\"emmy.calculus.derivative$derivative@443fe678\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/derivative-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/derivative-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5duDuUsmzkb1qEJNDKC1S5vmYi2HuJ\"} [:p [:<> \"The result of applying the derivative \"] [:code [:<> \"(D f)\"]] [:<> \" of a multivariable function \"] [:code [:<> \"f\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"to a sequence of \"] [:code [:<> \"args\"]] [:<> \" is a structure of the same shape as \"] [:code [:<> \"args\"]] [:<> \" with all\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"orientations flipped. (For a partial derivative like \"] [:code [:<> \"((partial 0 1) f)\"]] [:<> \" the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"result has the same-but-flipped shape as \"] [:code [:<> \"(get-in args [0 1])\"]] [:<> \".)\"]] [:p [:code [:<> \"args\"]] [:<> \" is coerced into an \"] [:code [:<> \"up\"]] [:<> \" structure. The only special case where this\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"does not happen is if \"] [:code [:<> \"(= 1 (count args))\"]] [:<> \".\"]] [:p [:<> \"To generate the result:\"]] [:ul [:li [:<> [:<> \"For a single non-structural argument, return \"] [:code [:<> \"(derivative f)\"]]]] [:li [:<> [:<> \"else, bundle up all arguments into a single [[s/Structure]] instance \"] [:code [:<> \"xs\"]]]] [:li [:<> [:<> \"Generate \"] [:code [:<> \"xs'\"]] [:<> \" by replacing each entry in \"] [:code [:<> \"xs\"]] [:<> \" with \"] [:code [:<> \"((derivative f') entry)\"]] [:<> \", where \"] [:code [:<> \"f'\"]] [:<> \" is a function of ONLY that entry that\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"calls \"] [:code [:<> \"(f (assoc-in xs path entry))\"]] [:<> \". In other words, replace each entry\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"with the result of the partial derivative of \"] [:code [:<> \"f\"]] [:<> \" at only that entry.\"]]] [:li [:<> [:<> \"Return \"] [:code [:<> \"(s/transpose xs')\"]] [:<> \" (the same structure with all orientations\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"flipped.)\"]]]] [:p [:<> \"A multivariable derivative is a multiple-arity function that performs the\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"above.\"]] [:p [:<> \"[[jacobian]] handles this main logic. [[jacobian]] can only take a structural\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"input. [[euclidean]] and [[multivariate]] below widen handle, respectively,\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"optionally-structural and multivariable arguments.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5duDuUsmzkb1qEJNDKC1S5vmYi2HuJ\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(defn- deep-partial\\n  \\\"Returns the partial derivative of `f` with respect to the entry in `structure`\\n  at the location `path`.\\n\\n  `entry` defaults to `(get-in structure path)`.\\\"\\n  ([f structure path]\\n   (let [entry (get-in structure path)]\\n     (deep-partial f structure path entry)))\\n  ([f structure path entry]\\n   (if (v/numerical? entry)\\n     (letfn [(f-entry [x]\\n               (f (assoc-in structure path x)))]\\n       ((derivative f-entry) entry))\\n     (u/illegal\\n      (str \\\"non-numerical entry \\\" entry\\n           \\\" at path \\\" path\\n           \\\" in input structure \\\" structure)))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/deep-partial-code\", :loc {:line 286, :end-line 302, :column 1, :end-column 49}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$deep_partial 0x20a7d018 \\\"emmy.calculus.derivative$deep_partial@20a7d018\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/deep-partial-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/deep-partial-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn- jacobian\\n  \\\"Takes:\\n\\n  - some function `f` of a single [[emmy.structure/structure?]] argument\\n  - the unperturbed structural `input`\\n  - a `selectors` vector that can be empty or contain a valid path into the\\n    `input` structure\\n\\n  and returns either:\\n\\n  - The full [Jacobian](https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant)\\n    of `f` at `input`, if `selectors` is empty\\n  - the entry of the Jacobian at `selectors`\\n\\n  The Jacobian has the same shape as `input` (or the entry at `selectors`) with\\n  all orientations flipped. Multiply this by an increment in the shape of\\n  `input` to produce an increment in the output of `f`.\\\"\\n  ([f input] (jacobian f input []))\\n  ([f input selectors]\\n   (letfn [(prefixed [path]\\n             (if (empty? selectors)\\n               path\\n               (into selectors path)))]\\n     (if-let [piece (get-in input selectors)]\\n       (let [frame (s/transpose piece)]\\n         ;; Visit each entry in `frame`, a copy of either the full input or the\\n         ;; sub-piece living at `selectors` (with all orientations flipped), and\\n         ;; replace the entry with the result of the partial derivative of `f`\\n         ;; with that entry perturbed.\\n         (s/map-chain\\n          (fn [entry path _]\\n            (deep-partial f input (prefixed path) entry))\\n          frame))\\n\\n       ;; The call to `get-in` will return nil if the `selectors` don't index\\n       ;; correctly into the supplied `input`, triggering this exception.\\n       (u/illegal (str \\\"Bad selectors \\\" selectors \\\" for structure \\\" input))))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/jacobian-code\", :loc {:line 304, :end-line 340, :column 1, :end-column 80}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$jacobian 0x3d27c483 \\\"emmy.calculus.derivative$jacobian@3d27c483\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/jacobian-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/jacobian-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn- euclidean\\n  \\\"Slightly more general version of [[jacobian]] that can handle a single\\n  non-structural input; dispatches to either [[jacobian]] or [[derivative]]\\n  depending on the input type.\\n\\n  If you pass non-empty `selectors`, the returned function will throw if it\\n  receives a non-structural, non-numerical argument.\\\"\\n  ([f] (euclidean f []))\\n  ([f selectors]\\n   (let [selectors (vec selectors)]\\n     (fn [input]\\n       (cond (s/structure? input)\\n             (jacobian f input selectors)\\n\\n             ;; non-empty selectors are only allowed for functions that receive\\n             ;; a structural argument. This case passes that single,\\n             ;; non-structural argument on to `(derivative f)`.\\n             (empty? selectors)\\n             ((derivative f) input)\\n\\n             ;; Any attempt to index (via non-empty selectors) into a\\n             ;; non-structural argument will throw.\\n             ;;\\n             ;; NOTE: What about matrices, maps or sequences? The current\\n             ;; implementation (as of 0.15.0) pushes the derivative operator\\n             ;; into the entries, or values, of those types, so they won't reach\\n             ;; this clause. There is a case I (@sritchie) can make for actually\\n             ;; allowing the first clause here to work for ANY associative\\n             ;; structure; then you're on your own if you want to call this fn\\n             ;; directly.\\n             :else\\n             (u/illegal\\n              (str \\\"Selectors \\\" selectors\\n                   \\\" not allowed for non-structural input \\\" input)))))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/euclidean-code\", :loc {:line 342, :end-line 375, :column 1, :end-column 73}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$euclidean 0x57466741 \\\"emmy.calculus.derivative$euclidean@57466741\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/euclidean-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/euclidean-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn- multivariate\\n  \\\"Slightly wider version of [[euclidean]]. Accepts:\\n\\n  - some function `f` of potentially many arguments\\n  - optionally, a sequence of selectors meant to index into the structural\\n    argument, or argument vector, of `f`\\n\\n  And returns a new function that computes either the\\n  full [Jacobian](https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant)\\n  or the entry at `selectors`.\\n\\n  Any multivariable function will have its argument vector coerced into an `up`\\n  structure. Any [[matrix/Matrix]] in a multiple-arg function call will be\\n  converted into a `down` of `up`s (a row of columns).\\n\\n  Single-argument functions don't transform their arguments.\\\"\\n  ([f] (multivariate f []))\\n  ([f selectors]\\n   (let [d #(euclidean % selectors)\\n         df (d f)\\n         df* (d (fn [args] (apply f args)))]\\n     (-> (fn\\n           ([] (constantly 0))\\n           ([x] (df x))\\n           ([x & more]\\n            (df* (matrix/seq-> (cons x more)))))\\n         (f/with-arity (f/arity f) {:from ::multivariate})))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/multivariate-code\", :loc {:line 377, :end-line 403, :column 1, :end-column 63}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$multivariate 0x6cf147f7 \\\"emmy.calculus.derivative$multivariate@6cf147f7\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/multivariate-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/multivariate-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5dskCFM1L9WhfYwhbtJDNDfcgArVmL\"} [\"h2\" {:id \"generic-[[g/partial-derivative]]-installation\"} [:<> \"Generic [[g/partial-derivative]] Installation\"]] [:p [:<> \"[[g/partial-derivative]] is meant to produce either a full Jacobian or some\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"entry specified by a \"] [:code [:<> \"selectors\"]] [:<> \" vector.\"]] [:p [:<> \"When called on a function \"] [:code [:<> \"f\"]] [:<> \", [[g/partial-derivative]] returns a function\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"wrapped in the machinery provided by [[multivariate]]; this allows the same\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"operator to serve functions of:\"]] [:ul [:li [:<> [:<> \"a single numerical input\"]]] [:li [:<> [:<> \"a single structural input\"]]] [:li [:<> [:<> \"multiple numerical OR structural inputs\"]]]] [:p [:<> \"NOTE: The reason that this implementation is also installed\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"for [[emmy.structure/Structure]] is that structures act as functions\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"that apply their args to every (functional) entry. Calling \"] [:code [:<> \"(multivariate  structure selectors)\"]] [:<> \" allows all of the machinery that handles\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"structure-walking and argument conversion to run a SINGLE time before getting\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"passed to the structure of functions, instead of separately for every entry\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"in the structure.\"]] [:p [:<> \"TODO: I think this is going to cause problems for, say, a Structure of\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"PowerSeries, where there is actually a cheap \"] [:code [:<> \"g/partial-derivative\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"implementation for the components. I vote to back out this \"] [:code [:<> \"::s/structure\"]] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"installation.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5dskCFM1L9WhfYwhbtJDNDfcgArVmL\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(doseq [t [::v/function ::s/structure]]\\n  (defmethod g/partial-derivative [t v/seqtype] [f selectors]\\n    (multivariate f selectors))\\n\\n  (defmethod g/partial-derivative [t nil] [f _]\\n    (multivariate f [])))\", :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5dtpwfFahAGwTmyWNFbyk7jkZyB4wN-code\", :loc {:line 431, :end-line 436, :column 1, :end-column 26}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value nil, :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5dtpwfFahAGwTmyWNFbyk7jkZyB4wN-result\"}, :nextjournal/viewer {:render-fn #viewer-fn (fn [_] [:span.cmt-default.inspected-value \"nil\"]), :hash \"5dtUvzjkkSGDKH896hrVHyYFWTpQG6\"}}, :nextjournal/blob-id \"5dtXPK134KtF4Epamtqs3G8ehBBaLr\"}, :nextjournal/opts {:id \"emmy.calculus.derivative/anon-expr-5dtpwfFahAGwTmyWNFbyk7jkZyB4wN-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5dqypNcc95JmE1pCxNQZZURjM9J4FL\"} [\"h2\" {:id \"operators\"} [:<> \"Operators\"]] [:p [:<> \"This section exposes various differential operators as [[o/Operator]]\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"instances.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5dqypNcc95JmE1pCxNQZZURjM9J4FL\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(def D\\n  \\\"Derivative operator. Takes some function `f` and returns a function\\n  whose value at some point can multiply an increment in the arguments, to\\n  produce the best linear estimate of the increment in the function value.\\n\\n  For univariate functions, [[D]] computes a derivative. For vector-valued\\n  functions, [[D]] computes\\n  the [Jacobian](https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant)\\n  of `f`.\\n\\n  The related [[Grad]] returns a function that produces a structure of the\\n  opposite orientation as [[D]]. Both of these functions use forward-mode\\n  automatic differentiation.\\\"\\n  (o/make-operator #(g/partial-derivative % [])\\n                   g/derivative-symbol))\", :nextjournal/opts {:id \"emmy.calculus.derivative/D-code\", :loc {:line 443, :end-line 457, :column 1, :end-column 41}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"D\", :nextjournal/opts {:id \"emmy.calculus.derivative/D-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id \"5drS4wzXrxE5hing7H7rXL4EeDhQMX\"}, :nextjournal/opts {:id \"emmy.calculus.derivative/D-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn D-as-matrix [F]\\n  (fn [s]\\n    (matrix/s->m\\n     (s/compatible-shape (F s))\\n     ((D F) s)\\n     s)))\", :nextjournal/opts {:id \"emmy.calculus.derivative/D-as-matrix-code\", :loc {:line 459, :end-line 464, :column 1, :end-column 10}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$D_as_matrix 0x7148bc77 \\\"emmy.calculus.derivative$D_as_matrix@7148bc77\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/D-as-matrix-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/D-as-matrix-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn partial\\n  \\\"Returns an operator that, when applied to a function `f`, produces a function\\n  that computes the partial derivative of `f` at the (zero-based) slot index\\n  provided via `selectors`.\\\"\\n  [& selectors]\\n  (o/make-operator #(g/partial-derivative % selectors)\\n                   `(~'partial ~@selectors)))\", :nextjournal/opts {:id \"emmy.calculus.derivative/partial-code\", :loc {:line 466, :end-line 472, :column 1, :end-column 46}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$partial 0x1550a170 \\\"emmy.calculus.derivative$partial@1550a170\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/partial-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/partial-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value [:div.viewer.markdown-viewer.w-full.max-w-prose.px-8 {:data-block-id \"emmy.calculus.derivative/markdown-5dtyFBcwTMkEdojv69jeVfineEx8qc\"} [\"h2\" {:id \"derivative-utilities\"} [:<> \"Derivative Utilities\"]] [:p [:<> \"Functions that make use of the differential operators defined above in\"] [#viewer-eval nextjournal.clerk.render/inspect-presented {:nextjournal/value [:<> \" \"], :nextjournal/viewer {:name nextjournal.clerk.viewer/html-viewer, :render-fn #viewer-fn identity, :hash \"5du5eveS8XMqMDMYH5rpQ1bqryEJdg\"}}] [:<> \"standard ways.\"]]], :nextjournal/opts {:id \"emmy.calculus.derivative/markdown-5dtyFBcwTMkEdojv69jeVfineEx8qc\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/markdown-node-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-with-react-key, :hash \"5drtFhRgc8WMLrXw6DB4bZLsNZjHHp\"}} {:path [], :nextjournal/value \"(defn taylor-series\\n  \\\"Given a differentiable function `f` and any number of arguments `xs`, returns\\n  a [[emmy.series/PowerSeries]] representing the [Taylor\\n  series](https://en.wikipedia.org/wiki/Taylor_series) of the function `f`\\n  expanded at `xs`.\\n\\n  Calling [[taylor-series]] with no arguments will return the [Maclaurin\\n  series](https://en.wikipedia.org/wiki/Taylor_series#List_of_Maclaurin_series_of_some_common_functions)\\n  of `f`, i.e., the Taylor series expansion at `(= x 0)`.\\n\\n  Calling the returned power series with incremental argument `dx` will produce\\n  a [[emmy.series/Series]] representing the terms of the Taylor series of\\n  `f` expanded at `x` and evaluated at `x+dx`.\\n\\n  NOTE: Just like the [[D]] operator, functions `f` of multiple-arguments are\\n  treated as a function of a single structural argument. If you pass multiple\\n  arguments `xs`, you'll have to manually wrap your multiple-argument `dx` in\\n  a [[emmy.structure/up]] or a vector before passing it to the returned\\n  power series.\\n\\n  NOTE: The typical definition of a Taylor series of `f` expanded around some\\n  point `x` is\\n\\n  $$T(p) = f(x) + \\\\\\\\frac{f'(x)}{1!}(p-x) + \\\\\\\\frac{f''(x)}{2!} (p-x)^2 + \\\\\\\\ldots,$$\\n\\n  where `p` is the evaluation point. When `(= p x)`, all derivatives of the\\n  Taylor series expansion of `f` will exactly match the derivatives of `f`\\n  itself.\\n\\n  The Taylor series returned here (call it $T'$) is actually a function of `dx`,\\n  where\\n\\n  $$T'(dx) = T(x+dx) = f(x) + \\\\\\\\frac{f'(x)}{1!}(dx) + \\\\\\\\frac{f''(x)}{2!} (dx)^2 + \\\\\\\\ldots.$$\\\"\\n  ([f] (taylor-series f 0))\\n  ([f & xs]\\n   (series/->function\\n    (apply ((g/exp D) f) xs))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/taylor-series-code\", :loc {:line 479, :end-line 515, :column 1, :end-column 32}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$taylor_series 0x73f892d2 \\\"emmy.calculus.derivative$taylor_series@73f892d2\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/taylor-series-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/taylor-series-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}} {:path [], :nextjournal/value \"(defn symbolic-taylor-series\\n  \\\"Similar to [[taylor-series]], except `f` is evaluated with symbolic arguments,\\n  and these arguments are only replaced with the values `xs` after Taylor series\\n  expansion.\\n\\n  Please see the docs for [[taylor-series]]!\\\"\\n  ([f] (symbolic-taylor-series f 0))\\n  ([f & xs]\\n   (let [syms      (map s/typical-object xs)\\n         replace-m (zipmap (flatten syms)\\n                           (flatten xs))\\n         series    (apply taylor-series f syms)]\\n     (letfn [(process-term [term]\\n               (g/simplify\\n                (s/mapr (fn rec [x]\\n                          (if (d/differential? x)\\n                            (d/map-coefficients rec x)\\n                            (-> (g/simplify x)\\n                                (x/substitute replace-m))))\\n                        term)))]\\n       (series/fmap process-term series)))))\", :nextjournal/opts {:id \"emmy.calculus.derivative/symbolic-taylor-series-code\", :loc {:line 517, :end-line 537, :column 1, :end-column 45}}, :nextjournal/viewer {:name nextjournal.clerk.viewer/code-block-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-code-block, :hash \"5dru1FUcVRTRrVKJFbNw4FG2wXmiwB\"}} {:path [], :nextjournal/value {:nextjournal/presented {:path [], :nextjournal/value \"#object[emmy.calculus.derivative$symbolic_taylor_series 0x42eadaa9 \\\"emmy.calculus.derivative$symbolic_taylor_series@42eadaa9\\\"]\", :nextjournal/opts {:id \"emmy.calculus.derivative/symbolic-taylor-series-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/read+inspect-viewer, :render-fn #viewer-fn (fn [x] (try [nextjournal.clerk.render/inspect (read-string x)] (catch js/Error _e (nextjournal.clerk.render/render-unreadable-edn x)))), :hash \"5driNqLjrByEWrhxqnAqaiYK9eiYCv\"}}, :nextjournal/blob-id nil}, :nextjournal/opts {:id \"emmy.calculus.derivative/symbolic-taylor-series-result\"}, :nextjournal/viewer {:name nextjournal.clerk.viewer/result-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-result, :hash \"5dtGVHesd2XCTLFYF3aY4kJvkrX1x1\"}}], :css-class nil}, :nextjournal/viewer {:name nextjournal.clerk.viewer/notebook-viewer, :render-fn #viewer-fn nextjournal.clerk.render/render-notebook, :hash \"5duAFDxE4sCnRX71Wo6zeCpC9C3djE\"}}}, :browse? false, :git/url \"https://github.com/mentat-collective/emmy\", :paths [\"src/emmy/differential.cljc\" \"src/emmy/calculus/derivative.cljc\"], :resource->url {\"/js/viewer.js\" \"https://storage.clerk.garden/nextjournal/clerk-assets@MsfrCWFPFxPwKtMLymKe2NxPBwY/viewer.js?immutable=true\"}, :current-path \"src/emmy/calculus/derivative.cljc\", :bundle? false, :git/sha \"db25912c4adcef13431318d7c3563f125c8bbbd7\", :path->url {\"src/emmy/differential.cljc\" \"src/emmy/differential.html\", \"src/emmy/calculus/derivative.cljc\" \"src/emmy/calculus/derivative.html\"}, :expanded-paths [\"src/emmy/differential.cljc\" \"src/emmy/calculus/derivative.cljc\"], :watch-paths [\"src\" \"dev\"], :report-fn #object[nextjournal.clerk.builder$stdout_reporter 0x642d19f0 \"nextjournal.clerk.builder$stdout_reporter@642d19f0\"]}".replaceAll('nextjournal.clerk.view/escape-closing-script-tag', 'script')
let opts = nextjournal.clerk.sci_env.read_string(state)
nextjournal.clerk.static_app.init(opts)
</script></body></html>